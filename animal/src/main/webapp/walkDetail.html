<!DOCTYPE html>
<html lang="ko">

<head>
    <link rel="icon" href="icon/1.ico" type="image/x-icon" />
    <meta charset="UTF-8">
    <title>산책코스</title>
    <link href="lib/bootstrap/dist/css/bootstrap.css" rel='stylesheet' type='text/css' />
    <!--  상훈 css  -->
    <link href="css/sh_slidmenu_header_diary.css" type="text/css" rel="stylesheet">
    <!-- 강현 css -->
    <link href="css/kh_walk_detail.css" type="text/css" rel="stylesheet">

    <!--  폰트아이콘 링크  -->
    <link href="lib/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
    <link href="css/icon-font.min.css" rel="stylesheet" />

    <script src='lib/jquery/jquery.min.js'></script>
    <script src="lib/bootstrap/dist/js/bootstrap.js"></script>
    <script src="lib/less/less.js" type="text/javascript"></script>

    <script src="lib/jquery-session-plugin/jquery.session.js" type="text/javascript"></script>


</head>

<body>
  <header id="menu">
    <div id="header_title">
      <a class="headerTitle" href="pet.html">
        <span id="the">THE</span> <span id="P">P</span><span id="et">ET</span>
      </a>
      <a class="headerSubTitle" href="walk.html">
        산책
      </a>
      <div id="user_info">
<!--          <a href='login.html' id='loginBtn'>로그인</a>-->
      </div>
    </div>
    <!--  메뉴 버튼  -->
    <input type="checkbox" id="menuToggle" />

    <div id="sideMenu">
      <label for="menuToggle" id="menu-icon"><i class="fa fa-bars fa-lg"></i></label>
      <!--  메뉴 내용  -->

      <nav id="menu-nav">
        <ul id="menu-nav-ul">
          <li><a href="Education/education.html"><i class="lnr lnr-pencil"></i> 교육</a></li>
          <li><a href="sale.html"><i class="lnr lnr-store"></i> 분양</a></li>
          <li><a href="mating.html"><i class="lnr lnr-heart"></i> 짝짓기</a></li>
          <li><a href="walk.html"><i class="lnr lnr-leaf"></i> 산책코스</a></li>
          <li><a href="BoastBoard/boastBoard.html"><i class="lnr lnr-paw"></i> 자랑해요</a></li>
        </ul>
      </nav>
      <!--  //메뉴 내용  -->
    </div>
  </header>

  <section id="main-body" >

    <div id="left">

      <div id='carousel-example-generic' class='carousel slide' data-ride='carousel' data-wrap='ture' data-interval="false">
        <!-- Indicators -->
        <ol class='carousel-indicators' id="dots"></ol>

        <!-- Wrapper for slides -->
        <div class="carousel-inner" role="listbox" id="imgs"></div>

        <!-- Controls -->
        <a class='left carousel-control' href='#carousel-example-generic' role='button' data-slide='prev'>
          <span class='glyphicon glyphicon-chevron-left' aria-hidden='true'>
            <i class="fa fa-arrow-circle-o-left"></i>
          </span>
          <span class='sr-only'>Previous</span>
        </a>
        <a class='right carousel-control' href='#carousel-example-generic' role="button" data-slide='next'>
          <span class='glyphicon glyphicon-chevron-right' aria-hidden='true'>
            <i class="fa fa-arrow-circle-o-right"></i>
          </span>
          <span class='sr-only'>Next</span>
        </a>
      </div>  <!-- 캐러셀 끝 -->

      <div id="detailTitle">
        <h3>
            <!-- 딸랑 딸랑 산책 코스 미리보기 딸랑 딸랑 -->
        </h3>
        <div id="like-section">
        <a role="button" id="likeBtn"><i class="fa fa-thumbs-o-up" id="likes"></i></a>
        <span id="likeCount"></span>
        </div>
      </div>  <!-- detailTitle 끝 -->

      <div id="mapNlist">

        <div id='map'></div>  <!-- 지도 출력부분 -->

        <div id="m-list"> <!-- 컨텐트 출력 -->
          <!-- 컨텐트 -->
        </div>  <!-- m-list 끝 -->

      </div>  <!-- mapNlist 끝 -->

      <div id="btn-Section">
          <div id="list">
              <input type="button" class="btn btn-default" value="목록" onclick="location.href='walk.html'"/>
          </div>
      </div>

      <div class='contents'>

        <!-- 댓글 입력부분 -->
        <div class='input'>
          <img id='comimg' src=''>
          <textarea id="comcontent" class='commentin' cols='30' rows='2' placeholder='댓글을 입력하세요...'></textarea>
          <a id="comAddBtn" role='button'>게시</a>
        </div>

        <!-- 댓글과 버튼을 포함한 구역 -->
        <div class='comments' id="comComment">
        </div>

        <div id="more">
            <a role="button" class="moreBtn" id="m10" onclick='moree(this.id);'>더보기</a>
        </div>

        <!-- 댓글과 버튼을 포함한 구역 끝 -->

      </div> <!-- contents 클래스 끝 -->

    </div> <!-- left 끝 -->

    <div id="right">
      <h4>더 많은 리스트</h4>

    </div>

  </section>
  <!-- 댓글 삭제 확인 모달 -->
  <div id="checkModal" class="modal fade bs-example-modal-sm" data-keyboard='false' data-backdrop='static'>
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class='modal-header'>
          댓글 삭제
        </div>
        <div class='modal-body'>
          이 댓글을 삭제하시겠어요?
          <input type="hidden" id="comno">
        </div>
        <div class='modal-footer'>
          <button type="button" id="closeDel" class="btn btn-default" data-dismiss="modal">취소</button>
          <button type="button" id="delCom" class="btn btn-danger">삭제</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modo" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <i class="fa fa-info"></i>
          알림
        </div>

        <div class="modal-body">
          <span id="modoinfo"></span>
        </div>

        <div class="modal-footer">
          <button type="button" id="okok" class="btn btn-primary" data-dismiss="modal">확인</button>
        </div>
      </div>
    </div>
  </div>

<script type="text/javascript" src="//apis.daum.net/maps/maps3.js?apikey=d6f32883b1f882092688e8062e26dd77&libraries=services"></script>
<script type="text/javascript" src='js/kh_map_walkDetail.js'></script>

<script>
var mapno = location.href.split('?')[1].split('=')[1];

$(document).ready(function() {
  // 로그인 회원 정보출력 세션없으면 로그인페이지로
  var no = $.session.get('mno');
  var div = $('#user_info');
  var ul = $('#menu-nav-ul');

  if (no == undefined) {
    div.append("<a href='login.html' id='loginBtn'>로그인</a>")

  } else {
    div.append(
      "<a role='button' id='msgBtn' class='Msg' href='messagebox.html'>" +
        "<i class='fa fa-envelope-o'></i>" +
        "<span class='badge' id='userBadge'>0</span>" +
      "</a>" +
      "<img src='files/" + $.session.get('mimg') + "' id='userImg' />" +
      "<a id='userName' href='#'>" + $.session.get('mname') + "</a>" +
      "<a role='button' id='outBtn' class='logout'>" +
        "<i class='fa fa-unlock fa-lg'></i>" +
      "</a>")

    ul.append(
      "<li><a href='diary.html'><i class='lnr lnr-book'></i> 다이어리</a></li>")

    $('#comimg').attr('src', 'files/' + $.session.get('mimg'));

  }

  // 로그아웃
  $(document).on("click", "#outBtn", function() {
    $.session.clear();
    location.href = "login.html"
  });

});

// 산책 디테일
$.ajax({
    url: 'diary/ajax/walklist.do',
    dataType: 'json',
    async: false,
    cache: false,
    data: {
      "dno": mapno
    },
    type: 'post',
    success: function(re) {

      $('#m-list').html(re.diary.content)
      $('h3').html(re.diary.title)
      $('#likeCount').html(re.diary.like)

      var mno = $.session.get('mno');
      var dno = location.href.split('?')[1].split('=')[1];
      if (mno != undefined) {

        var form_data = new FormData();
        form_data.append("mno", mno);
        form_data.append("dno", dno);

        $.ajax({
          url : "walk/ajax/detail_like_check.do",
          dataType : "json",
          type : "POST",
          contentType : false,
          processData : false,
          async: false,
          data : form_data,
          success : function(resultObj) {

            if (resultObj.like != null ) {
              $('#likes').css("color","blue");
              like_toggle = 1;
            } else {
              $('#likes').css("color","#767475");
              like_toggle = 0;
            }
          }
        });
      }
    }
});

// 랭크 리스트
$.ajax({
    url: 'walk/ajax/ranklist.do',
    dataType: 'json',
    type: 'post',
    async: false,
    data: {
        dno: mapno
    },
    cache: false,
    success: function(re) {
        console.log(re)
        var right = $('#right');
        var file;
        var imgWidth;
        var imgHeight;
        var setClass;
        for (var i = 0; i < re.top10.length; i++) {
            file = re.files[i];

            imgWidth = file[0].width;
            imgHeight = file[0].height;

            if (imgWidth > imgHeight) {
              setClass = "smlandscape"
            } else {
              setClass = "smportrait"
            }

            for (var j = 0; j < re.location.length; j++) {
                if (re.top10[i].dno == re.location[j].dno) {

                    right.append(
                        '<a onclick="detailWalk(' + re.top10[i].dno + ')" class="listbox" role="button">' +
                          '<div class="imgsize">' +
                            '<img class="' + setClass + ' boximg" src="files/' + file[0].fileName + '">' +
                          '</div>' +
                          '<div class="content">' +
                            '<div class="boxtitle">' + re.top10[i].title + '</div>' +
                            '<div class="boxwriter">' + re.member[i].mName + '</div>' +
                            '<div class="boxview">조회수 ' + re.top10[i].view + '</div>' +
                            '<div class="boxlike"><i class="fa fa-thumbs-o-up"></i> ' + re.top10[i].like + '</div>' +
                          '</div>' +
                        '</a>'
                    )
                }
            }
        }
    }
});
function detailWalk(dno) {

  var view_data = new FormData();
  view_data.append("dno", dno);

  $.ajax({
    url : "walk/ajax/view.do",
    dataType : "json",
    type : "POST",
    contentType : false,
    processData : false,
    data : view_data,
    success : function(resultObj) {

    }
  });

  location.href = 'walkDetail.html?dno=' + dno;
}

// 사진 디테일
$.ajax({
    url: "files/ajax/list.do",
    dataType: 'json',
    cache: false,
    async: false,
    data: {
        "dno": mapno
    },
    type: 'post',
    success: function(re) {
      var imgs = $("#imgs");
      var dots = $("#dots");
      var files = re.ajaxResult.data;
      var i = 0;
      for (var file of files) {
        if (i == 0) {
          imgs.append(
          "<div class='item active'>" +
            "<img class='slideimg' src='files/" + file.fileName + "'>" +
          "</div>")
          dots.append(
          "<li data-target='#carousel-example-generic' data-slide-to='" + i +
          "' class='active'></li>")
        } else {
          imgs.append(
          "<div class='item'>" +
            "<img class='slideimg' src='files/" + file.fileName + "'>" +
          "</div>")
          dots.append(
          "<li data-target='#carousel-example-generic' data-slide-to='" + i +
          "'></li>")
        }
        i++;
      }
    }
});

// 지도 팝업창
$.ajax({
  url: "walk/ajax/list.do",
  data: {
    "dno": mapno
  },
  async: false,
  cache: false,
  type: "get",
  dataType: "json",
  success: function(re) {
    coord = new daum.maps.LatLng(re.walkList[0].locLat, re.walkList[0].locLng);
    bounds.extend(coord);
    map.setBounds(bounds)
    marker.setPosition(coord);
    map.panBy(0, -55);
    overlay.setPosition(coord);
    var content =
    '<div class="wrap">' +
        '<div class="info">' +
            '<div class="title">' +
                re.walkList[0].locName +
                '<div class="close" onclick="closeOverlay()" title="닫기"></div>' +
            '</div>' +
            '<div style="margin-top: 3px;"><i class="fa fa-map-marker fa-fw text-muted"></i>' + re.walkList[0].locDong + '</div>' +
        '</div>' +
    '</div>';
    overlay.setContent(content);
  }
});

var i = 0;
// 댓글 리스트
var form_data = new FormData();
form_data.append("dno", mapno)
$.ajax({
    url: "comment/ajax/walkcomlist.do",
    dataType: 'json',
    async: false,
    cache: false,
    contentType: false,
    processData: false,
    data: form_data,
    type: 'post',
    success: function(re) {
        $('#comComment').empty();
        var commen = re.comments;
        var comdiv = $('#comComment');
        var mem;
        var j = 0;
        for (var com of commen) {
            mem = re.memberMap[j];
            if($.session.get('mno') == mem.mno) {
                comdiv.append(
                "<div class='comment'>" +
                "<img class='commentimg' src='files/" + mem.mImg + "'>" +
                "<div class='commentname'>" + mem.mName + "</div>" +
                "<a class='commentDel' id='" + com.comNo + "' onclick='del(this.id)'>" +
                "<i class='fa fa-close'></i></a>" +
                "<div class='commenttext'>" + com.comComment + "</div>" +
                "</div>")
            } else {
                comdiv.append(
                "<div class='comment'>" +
                "<img class='commentimg' src='files/" + mem.mImg + "'>" +
                "<div class='commentname'>" + mem.mName + "</div>" +
                "<div class='commenttext'>" + com.comComment + "</div>" +
                "</div>")
            }
            j++;
        }
    },
    complete: function() {
        i++;
    }
});

$.getJSON('comment/ajax/pages.do?dno=' + mapno, function(resultObj) {
    var ajaxResult = resultObj.ajaxResult
    // console.log(resultObj)
    if (ajaxResult.data == 0 || ajaxResult.data == 1) {
        $('#more').empty();
    }
})

// 댓글 추가
$(document).on('click', '#comAddBtn', function() {
  if ($('#comcontent').val() == "") {
    $('#modoinfo').html('댓글을 입력해 주세요.');
    $('#modo').modal('show')

  } else {
    var form_data = new FormData();
    form_data.append("dno", mapno)
    form_data.append("comComment", $('#comcontent').val())
    form_data.append("mno", $.session.get('mno'))
    $.ajax({
      url: "comment/ajax/walkcom.do",
      dataType: 'json',
      cache: false,
      async: false,
      contentType: false,
      processData: false,
      data: form_data,
      type: 'post',
      success: function(re) {
        $('#comcontent').val('')
        var form_data = new FormData();
        form_data.append("dno", mapno)
        $.ajax({
          url: "comment/ajax/walkcomlist.do",
          dataType: 'json',
          cache: false,
          contentType: false,
          processData: false,
          data: form_data,
          type: 'post',
          success: function(re) {
            $('#comComment').empty();
            var commen = re.comments;
            var comdiv = $('#comComment');
            var mem;
            var j = 0;
            for (var com of commen) {
              mem = re.memberMap[j];
              if($.session.get('mno') == mem.mno) {
                comdiv.append(
                "<div class='comment'>" +
                "<img class='commentimg' src='files/" + mem.mImg + "'>" +
                "<div class='commentname'>" + mem.mName + "</div>" +
                "<a class='commentDel' id='" + com.comNo + "' onclick='del(this.id)'>" +
                "<i class='fa fa-close'></i></a>" +
                "<div class='commenttext'>" + com.comComment + "</div>" +
                "</div>")
              } else {
                comdiv.append(
                "<div class='comment'>" +
                "<img class='commentimg' src='files/" + mem.mImg + "'>" +
                "<div class='commentname'>" + mem.mName + "</div>" +
                "<div class='commenttext'>" + com.comComment + "</div>" +
                "</div>")
              }
              j++;
            }
            $('#more').empty();
            $.getJSON('comment/ajax/pages.do?dno=' + mapno, function(resultObj) {
              var ajaxResult = resultObj.ajaxResult
              console.log(resultObj)
              if (ajaxResult.data == 0 || ajaxResult.data == 1) {
                $('#more').empty();
              }
              else {
                $('#more').append(
                  '<a role="button" class="moreBtn" id="m10" onclick="moree(this.id);">더보기</a>');
              }
            })
            i=1;
          }
        })
      }
    })
  }
});

// 댓글 삭제 도우미
function del(id) {
  $('#comno').val(id)
  $('#checkModal').modal('show')
}

// 댓글 삭제
$(document).on("click", "#delCom", function() {
  var form_data = new FormData();
  console.log($('#comno').val())
  form_data.append("comNo", $('#comno').val())
  $.ajax({
    url: "comment/ajax/delete.do",
    dataType: 'json',
    cache: false,
    contentType: false,
    processData: false,
    data: form_data,
    type: 'post',
    success: function(re) {
      $('#checkModal').modal('hide')
      var form_data = new FormData();
      form_data.append("dno", mapno)
      $.ajax({
        url: "comment/ajax/walkcomlist.do",
        dataType: 'json',
        cache: false,
        contentType: false,
        processData: false,
        data: form_data,
        type: 'post',
        success: function(re) {
          $('#comComment').empty();
          var commen = re.comments;
          var comdiv = $('#comComment');
          var mem;
          var j = 0;
          for (var com of commen) {
            mem = re.memberMap[j];
            comdiv.append(
            "<div class='comment'>" +
            "<img class='commentimg' src='files/" + mem.mImg + "'>" +
            "<div class='commentname'>" + mem.mName + "</div>" +
            "<a class='commentDel' id='" + com.comNo + "' onclick='del(this.id)'>" +
            "<i class='fa fa-close'></i></a>" +
            "<div class='commenttext'>" + com.comComment + "</div>" +
            "</div>")
            j++;
          }
          $('#more').empty();
          $.getJSON('comment/ajax/pages.do?dno=' + mapno, function(resultObj) {
            var ajaxResult = resultObj.ajaxResult
            console.log(resultObj)
            if (ajaxResult.data == 0 || ajaxResult.data == 1) {
              $('#more').empty();
            }
            else {
              $('#more').append(
                '<a role="button" class="moreBtn" id="m10" onclick="moree(this.id);">더보기</a>'
              );
            }
          })
          i=1;
        }
      })
    }
  })
})

// 더보기 부분
function moree(id) {
  i++;
  console.log(id);
  var page = id.substring(1);
  console.log(page);
  var cpage = i;
  var form_data = new FormData();
  form_data.append("dno", mapno)
  form_data.append("pageNo", page)
  $.ajax({
    url: "comment/ajax/walkcomlist.do",
    dataType: 'json',
    cache: false,
    contentType: false,
    processData: false,
    data: form_data,
    type: 'post',
    success: function(re) {
      var commen = re.comments;
      var comdiv = $('#comComment');
      var mem;
      var j = 0;
      for (var com of commen) {
        mem = re.memberMap[j];
        if($.session.get('mno') == mem.mno) {
          comdiv.append(
          "<div class='comment'>" +
          "<img class='commentimg' src='files/" + mem.mImg + "'>" +
          "<div class='commentname'>" + mem.mName + "</div>" +
          "<a class='commentDel' id='" + com.comNo + "' onclick='del(this.id)'>" +
          "<i class='fa fa-close'></i></a>" +
          "<div class='commenttext'>" + com.comComment + "</div>" +
          "</div>")
        } else {
          comdiv.append(
          "<div class='comment'>" +
          "<img class='commentimg' src='files/" + mem.mImg + "'>" +
          "<div class='commentname'>" + mem.mName + "</div>" +
          "<div class='commenttext'>" + com.comComment + "</div>" +
          "</div>")
        }
        j++;
      }
      $("#hidden").trigger("click");
      $("button:first").trigger("click");

      $.getJSON('comment/ajax/pages.do?dno=' + mapno, function(resultObj) {
        var ajaxResult = resultObj.ajaxResult;
        console.log(cpage);
        if (ajaxResult.data == cpage) {
          console.log("더보기 끝")
          $('#more').empty();

        } else {
          console.log("더보기 생성")
          var more = $('#more');
          $('#more').empty();
          var i = parseInt(page)+10;
          console.log(i);
          more.append(
            "<a role='button' class='moreBtn' id='m" + i + "' onclick='moree(this.id);'>더보기</a>")
        }
      })
    }
  })
};
</script>

<script>

// 좋아요(Likes) Toggle 기능
$('#likes').click(function(event) {

  var mno = $.session.get('mno');
  var dno = location.href.split('?')[1].split('=')[1];

  var form_data = new FormData();

  form_data.append("mno", mno);
  form_data.append("dno", dno);


  if ($.session.get('mno') == undefined) {

    $('#modoinfo').html('로그인 후 이용해 주세요.');
    $('#modo').modal('show')

  } else {
    $.ajax({
      url : "walk/ajax/detail_like_check.do",
      dataType : "json",
      type : "POST",
      contentType : false,
      processData : false,
      async: false,
      data : form_data,
      success : function(resultObj) {
        console.log("resultObj.like : " + resultObj.like)
        if (resultObj.like != null ) {
          like_toggle = 1;
        } else {
          like_toggle = 0;
        }
        console.log("like_toggle : " + like_toggle)
        if(like_toggle == 0) {
          $.ajax({
            url : "walk/ajax/likeAdd.do",
            dataType : "json",
            type : "POST",
            contentType : false,
            processData : false,
            async: false,
            data : form_data,
            success : function(resultObj) {
              $('#likeCount').remove();
              $('#like-section').append("<span id='likeCount'>" + resultObj.like + "</span>")
            }
          });

          $('#likes').css({"color":"blue"});
          like_toggle = 1;

        } else if(like_toggle == 1) {

          $.ajax({
            url : "walk/ajax/likeDel.do",
            dataType : "json",
            type : "POST",
            contentType : false,
            processData : false,
            async: false,
            data : form_data,
            success : function(resultObj) {
              $('#likeCount').remove();
              $('#like-section').append("<span id='likeCount'>" + resultObj.like + "</span>")
            }
          });

          $('#likes').css({"color":"#767475"});
          like_toggle = 0;
        }
      }
    });
  }
});
</script>
</body>

</html>
