<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link rel="icon" href="icon/1.ico" type="image/x-icon" />
  <title>Slid Menu</title>
  <!--  내가만든 less들  -->
  <link href="lib/bootstrap/dist/css/bootstrap.css" rel='stylesheet' type='text/css' />
  <link href="lib/jquery-uploadfile/css/uploadfile.css" rel="stylesheet" />
  <link href="css/sh_slidmenu_header_diary.css" type="text/css" rel="stylesheet">
  <link href="css/sh_diary_form.css" rel="stylesheet" />

  <!--  폰트아이콘 링크  -->
  <link href="lib/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
  <link href="css/icon-font.min.css" rel="stylesheet" />

  <link href='css/sh_map_diaryform.css' rel='stylesheet' />

  <script src='lib/jquery/jquery.js'></script>
  <script src="lib/bootstrap/dist/js/bootstrap.js"></script>
  <script src="lib/jquery-session-plugin/jquery.session.js" type="text/javascript"></script>
  <script src="lib/jquery-uploadfile/js/jquery.uploadfile.js" type="text/javascript"></script>
</head>

<body>
  <header id="menu">
    <div id="header_title">
      <a class="headerTitle" href="pet.html">
        <span id="the">THE</span> <span id="P">P</span><span id="et">ET</span>
      </a>
      <a class="headerSubTitle" href="diary.html">
        다이어리
      </a>
      <div id="user_info"></div>
    </div>
    <!--  메뉴 버튼  -->
    <input type="checkbox" id="menuToggle" />

    <div id="sideMenu">
      <label for="menuToggle" id="menu-icon"><i class="fa fa-bars fa-lg"></i></label>
      <!--  메뉴 내용  -->

      <nav id="menu-nav">
        <ul id="menu-nav-ul">
          <li><a href="Education/education.html"><i class="lnr lnr-pencil"></i> 교육</a></li>
          <li><a href="#"><i class="lnr lnr-store"></i> 분양</a></li>
          <li><a href="mating.html"><i class="lnr lnr-heart"></i> 짝짓기</a></li>
          <li><a href="walk.html"><i class="lnr lnr-leaf"></i> 산책코스</a></li>
          <li><a href="BoastBoard/boastBoard.html"><i class="lnr lnr-paw"></i> 자랑해요</a></li>
          <li><a href='diary.html'><i class='lnr lnr-book'></i> 다이어리</a></li>
        </ul>
      </nav>
      <!--  //메뉴 내용  -->
    </div>
  </header>

  <section id="main-body">
    <div id="left">

      <div id="form-header">
        <h3 class="ftitle" id="lineModalLabel">글 추가</h3>
      </div>

      <div id="form-body">

        <input type="hidden" name="mno" id="myMno2">
        <input type="hidden" name="lastDno" id="lastDno">

        <div class="form-group">
          <label class="col-sm-2 control-label">전체공개</label>
          <div class="switch">
            <input type="checkbox" name="dmhide" id="dmhide" checked>
            <label for="dmhide">
              <span class="fa fa-check"></span>
              <span class="fa fa-times"></span>
              <div></div>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label for="cateCode" class="col-sm-2 control-label">카테고리</label>
          <div class="col-sm-10">
            <select id="cateCode" name="cateCode" class="form-control">
              <option value="SANCHE" selected="selected">산책코스</option>
              <option value="JARANG">자랑해요</option>
              <option value="ILJUNG">펫 일정</option>
            </select>
        </div>
        </div>

        <div class="form-group">
          <label for="pno" class="col-sm-2 control-label">펫 선택</label>
          <div class="col-sm-10">
            <select id="pno" name="pno" class="form-control" required>
              <option value="">==펫 선택==</option>
            </select>
          </div>
        </div>

        <div class="pDate form-group">
          <label class="col-sm-2 control-label">시작일</label>
          <div class="col-sm-10">
            <input type="date" name="startDate" id="startDate" class="form-control" required>
          </div>
        </div>

        <div class="pDate form-group">
          <label class="col-sm-2 control-label">종료일</label>
          <div class="col-sm-10">
            <input type="date" name="endDate" id="endDate" class="form-control">
          </div>
        </div>

        <div class="form-group">
          <label for="ftitle" class="col-sm-2 control-label">제목</label>
          <div class="col-sm-10">
            <input type="text" name="title" class="form-control" id="title" required>
          </div>
        </div>

        <div class="form-group">
          <label for="fcontent" class="col-sm-2 control-label">내용</label>
          <div class="col-sm-10">
            <textarea id="fContent" name="content" class="form-control" rows='10' cols='60' required></textarea>
          </div>
        </div>

        <div class="pMap form-group">
          <label for="fsubtitle" class="col-sm-2 control-label">장소명</label>
          <div class="col-sm-10">
            <input type="text" name="subtitle" class="form-control" id="subtitle" required>
          </div>
        </div>

        <div class='pMap form-group'>
          <span id="explain">- 장소는 한곳만 선택하실수 있습니다.</span>
          <label for='flocation' class='col-sm-2 control-label'>지도</label>
          <img src='images/where.jpg' id='where' role='button' />
          <div id='map'></div>
        </div>

      </div>

      <div class="form-footer">
        <div class="col-sm-offset-2 col-sm-10">
          <button id='addBtn' type='button' class="newForm btn btn-primary btn-xs">등록</button>
        </div>
      </div>
    </div>

    <div id="right">
      <div id="fileuploader">upload</div>
    </div>
  </section>
  
  <div id="modo" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <i class="fa fa-exclamation-triangle"></i>
        에러!
      </div>
      
      <div class="modal-body">
        모두 입력해주세요
      </div>
      
      <div class="modal-footer">
        <button type="button" id="okok" class="btn btn-primary" data-dismiss="modal">확인</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript" src="//apis.daum.net/maps/maps3.js?apikey=d6f32883b1f882092688e8062e26dd77&libraries=services"></script>
<script type='text/javascript' src='js/kh_map_walk.js'></script>

<script>
$(document).ready(function() {

  // 로그인 회원 정보출력 세션없으면 로그인페이지로
  var no = $.session.get('mno');
  if (no == undefined) {
//    location.href = "diary.html"
  }
  $('#myMno1').val(no);
  $('#myMno2').val(no);

  var div = $('#user_info');
  div.append(
    "<a role='button' id='msgBtn' class='Msg' href='messagebox.html'>" +
      "<i class='fa fa-envelope-o'></i>" +
      "<span class='badge' id='userBadge'>0</span>" +
    "</a>" +
    "<img src='files/" + $.session.get('mimg') + "' id='userImg' />" +
    "<a id='userName' href='#'>" + $.session.get('mname') + "</a>" +
    "<a role='button' id='outBtn' class='logout'>" +
      "<i class='fa fa-unlock fa-lg'></i>" +
    "</a>")

  //    로그아웃
  $(document).on("click", "#outBtn", function() {
    $.session.clear();
    location.href = "login.html"
  });

  // 안읽은 받은쪽지 갯수 출력
  var no = $.session.get('mno');
  var form_data = new FormData();
  form_data.append("recvMno", no)
  $.ajax({
    url: 'message/ajax/noReadMsg.do',
    type: 'post',
//    async: false,
    dataType: 'json',
    cache: false,
    contentType: false,
    processData: false,
    data: form_data,
    success: function(resultObj) {
      var ajaxResult = resultObj.ajaxResult;
      $('#count').html(ajaxResult.data.noReadCount)
      $('#userBadge').html(ajaxResult.data.noReadCount)
    }
  })


  var uploadObj = $("#fileuploader").uploadFile({
    url : "files/ajax/upload.do",
    autoSubmit: false,
    multiple: true,
    dragDrop: true,
    fileName : "file",
    returnType: "json",
    enctype: "multipart/form-data",
    uploadStr: "이미지 추가",
    dragDropStr: "<span><b>드래그 & 드랍 파일</b></span>",
    cancelStr: "선택취소",
    abortStr: "전송취소",
    dynamicFormData: function() {
        var data = {
            file: "files",
            fileName: "files.name",
            dno: $('#lastDno').val()
        };
        return data;
    },
    afterUploadAll: function() {
        location.href='diary.html';
    }
  });

  $.getJSON('pet/ajax/list.do?mno=' + no, function(resultObj) {
    var sel = $("#pno");
    for (var pet of resultObj.pets) {
      sel.append("<option value='" + pet.pno + "'>" + pet.pName + "</option>")
    }
  })

  // 다이어리 추가
  var sel;
  $("#cateCode").change(function() {
      sel = $('#cateCode').val();
  }).change();

  $(document).on("click", "#addBtn", function(event) {
    if (sel === 'ILJUNG') {
      if ($('#pno').val() == "" ||
        $('#title').val() == "" ||
        $('#startDate').val() == "" ||
        $('#endDate').val() == "" ||
        $('#fContent').val() == "") {
        
        $('#modo').modal('show');
        return false;
        
      } else {
        var form_data = new FormData();
        var x = document.getElementById("dmhide").checked;
        var q;
        if (x) {
            q = 1;
        } else {
            q = 0;
        }
        console.log(q)
        form_data.append("mno", $('#myMno2').val())
        form_data.append("dhide", q)
        form_data.append("cateCode", $('#cateCode').val())
        form_data.append("pno", $('#pno').val())
        form_data.append("startDate", $('#startDate').val())
        form_data.append("endDate", $('#endDate').val())
        form_data.append("title", $('#title').val())
        form_data.append("content", $('#fContent').val())
        $.ajax({
          url: "diary/ajax/add.do",
          dataType: 'json',
          cache: false,
          contentType: false,
          processData: false,
          data: form_data,
          type: 'post',
          success: function(re) {
            var lastDno = re.ajaxResult.data;
            $('#lastDno').val(lastDno);

            uploadObj.startUpload();

//            location.href = "diary.html"
          }
        })
      }
    } else if (sel === 'SANCHE') {
      if ($('#pno').val() == "" ||
        $('#title').val() == "" ||
        $('#fContent').val() == "" ||
  //      $('#fileuploader').val() == "" ||
        $('#subtitle').val() =="") {
        
        $('#modo').modal('show');
        return false;
        
      } else {
        var form_data = new FormData();
        var x = document.getElementById("dmhide").checked;
        var q;
        if (x) {
          q = 1;
        } else {
          q = 0;
        }
        console.log(q)
        form_data.append("mno", $('#myMno2').val())
        form_data.append("dhide", q)
        form_data.append("cateCode", $('#cateCode').val())
        form_data.append("pno", $('#pno').val())
        form_data.append("startDate", $('#startDate').val())
        form_data.append("endDate", $('#endDate').val())
        form_data.append("title", $('#title').val())
        form_data.append("content", $('#fContent').val())
        $.ajax({
          url: "diary/ajax/add.do",
          dataType: 'json',
          cache: false,
          contentType: false,
          processData: false,
          data: form_data,
          type: 'post',
          success: function(re) {

            var lastDno = re.ajaxResult.data;
            $('#lastDno').val(lastDno);
            console.log("lastDno : " + $('#lastDno').val());

            var geocoder = new daum.maps.services.Geocoder();
            geocoder.coord2detailaddr({
              coord: new daum.maps.LatLng(dotlat, dotlng),
              callback: function(status, result) {
                $.ajax({
                  url: "walk/ajax/add.do",
                  dataType: "json",
                  type: "post",
                  data: {
                    locLat: dotlat,
                    locLng: dotlng,
                    locName: $('#subtitle').val(),
                    dno: lastDno,
                    locDong: result[0].region
                  },
                  success: function(resultObj) {
                    deleteCircleDot();

                    uploadObj.startUpload();

                    // location.href = "diary.html"
                  }
                })
              }
            });
          }
        });
      }
    } else if (sel === 'JARANG') {
      if ($('#pno').val() == "" ||
        $('#title').val() == "" ||
        $('#fContent').val() == "") {
        
        $('#modo').modal('show');
        return false;
        
      } else {
        var form_data = new FormData();
        var x = document.getElementById("dmhide").checked;
        var q;
        if (x) {
          q = 1;
        } else {
          q = 0;
        }
        console.log(q)
        form_data.append("mno", $('#myMno2').val())
        form_data.append("dhide", q)
        form_data.append("cateCode", $('#cateCode').val())
        form_data.append("pno", $('#pno').val())
        form_data.append("title", $('#title').val())
        form_data.append("content", $('#fContent').val())
        form_data.append("startDate", $('#startDate').val())
        form_data.append("endDate", $('#endDate').val())
        $.ajax({
          url: "diary/ajax/add.do",
          dataType: 'json',
          cache: false,
          contentType: false,
          processData: false,
          data: form_data,
          type: 'post',
          success: function(re) {
            var lastDno = re.ajaxResult.data;
            $('#lastDno').val(lastDno);

            uploadObj.startUpload();

//            location.href = "diary.html"
          }
        })
      }
    }
  });
})

// 글쓰기 카테고리 선택 부분
$("#cateCode").change(function() {
  if ($('#cateCode').val() == "JARANG") { // 자랑 해요
    $('.pDate').css('display', 'none');
    $('.pMap').css('display', 'none');
  }
  else if ($('#cateCode').val() == "SANCHE") {
    $('.pDate').css('display', 'none');
    $('.pMap').css('display', '');
  }
  else if ($('#cateCode').val() == 'ILJUNG'){
    $('.pDate').css('display', '');
    $('.pMap').css('display', 'none');
  }
}).change();
</script>

</body>
</html>
