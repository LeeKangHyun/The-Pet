<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="icon" href="../icon/1.ico" type="image/x-icon" />
<title>Slid Menu</title>

<link href="../lib/bootstrap/dist/css/bootstrap.css" rel='stylesheet' type='text/css' />

<!--  상훈 css  -->
<link href="../css/sh_slidmenu_header_diary.css" type="text/css" rel="stylesheet">
  
<!--  폰트아이콘 링크  -->
<link href="../lib/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
<link href="../css/icon-font.min.css" rel="stylesheet" />

<!-- 부트스트랩 -->
<script src='../lib/jquery/jquery.min.js'></script>
<script src="../lib/bootstrap/dist/js/bootstrap.js"></script>

<script src="../lib/jquery-session-plugin/jquery.session.js" type="text/javascript"></script>

<!-- 대진 css & js -->
<link href="../css/dj_main.css" type="text/css" rel="stylesheet">
<link href="../css/dj_detail.css" type="text/css" rel="stylesheet">

</head>
<body style="background-color:#efefdc;">
  <header id="menu">
    <div id="header_title">
      <a class="headerTitle" href="../pet.html">
        <span id="the">THE</span> <span id="P">P</span><span id="et">ET</span>
      </a>
      <div id="user_info"></div>
    </div>
    <!--  메뉴 버튼  -->
    <input type="checkbox" id="menuToggle" />

    <div id="sideMenu">
      <label for="menuToggle" id="menu-icon"><i class="fa fa-bars fa-lg"></i></label>
      <!--  메뉴 내용  -->

      <nav id="menu-nav">
        <ul id="menu-nav-ul">
          <li><a href="education.html"><i class="lnr lnr-pencil"></i> 교육</a></li>
          <li><a href=#><i class="lnr lnr-store"></i> 분양</a></li>
          <li><a href="../mating.html"><i class="lnr lnr-heart"></i> 짝짓기</a></li>
          <li><a href="../walk.html"><i class="lnr lnr-leaf"></i> 산책코스</a></li>
          <li><a href="../BoastBoard/boastBoard.html"><i class="lnr lnr-paw"></i> 자랑해요</a></li>
        </ul>
      </nav>
      <!--  //메뉴 내용  -->
    </div>
  </header>
  <section>
    <div class="m_content">
      <div id="va"></div>
      <div id="ca"></div>
      <div id="sa">
      <div style='font-size:21px; margin-bottom:10px;'>관련된 동영상</div>
      </div>
      <div class='contents'>

        <!-- 댓글 입력부분 -->
        <div class='input'>
          <img id='comimg' src=''>
          <textarea id="comcontent" class='commentin' cols='30' rows='2' placeholder='댓글을 입력하세요...'></textarea>
          <a id="comAddBtn" role='button'>게시</a>
        </div>

        <!-- 댓글과 버튼을 포함한 구역 -->
        <div class='comments' id="comComment">
        </div>

        <div id="more">
            <a role="button" class="moreBtn" id="m10" onclick='moree(this.id);'>더보기</a>
        </div>

        <!-- 댓글과 버튼을 포함한 구역 끝 -->

      </div> <!-- contents 클래스 끝 -->
    </div>
    
    <!-- 댓글 삭제 확인 모달 -->
    <div id="checkModal" class="modal fade bs-example-modal-sm" data-keyboard='false' data-backdrop='static'>
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class='modal-header'>
            댓글 삭제
          </div>
          <div class='modal-body'>
            이 댓글을 삭제하시겠어요?
            <input type="hidden" id="comno">
          </div>
          <div class='modal-footer'>
            <button type="button" id="closeDel" class="btn btn-default" data-dismiss="modal">취소</button>
            <button type="button" id="delCom" class="btn btn-danger">삭제</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    var eduNo = location.href.split('?')[1].split('=')[1];
    var id = eduNo;
    console.log(eduNo);
    $.ajax({
      url : 'education/ajax/detail.do',
      dataType : 'json',
      type : "get",
      cache : true,
      data : {
        eduNo : eduNo
      },
      success : function(resultObj) {
        var education = resultObj.education;
        var files = resultObj.files;
        var url = (files[0].fileName).split('?')[1].split('=')[1];
        var va = $("#va");  // video area
        var ca = $("#ca");  // content area
        var sa = $("#sa");  // side area
        var ra = $("#ra");  // reply area
        $("<iframe class='videoarea' src='https://www.youtube.com/embed/" 
        		+ url + "?rel=0'" +
        		"' frameborder='0' allowfullscreen></iframe>'")	
        .appendTo(va);
        $("<div class='title'>" + education.eduTitle +
        		"<div id='views'><i class='fa fa-eye' style='padding-right:30px;'></i>" + education.eduViews + "</div>" +
        	  "<hr>" + "<div class='da'>작성일 : " + education.eduCreateDate + "</div>" +
        		"</div>")
        .appendTo(ca);
        $("#eduContent").val(education.eduContent);
        console.log(education.eduSpec);
        $.ajax({
        	    url : 'education/ajax/slist.do',
            dataType : 'json',
            type : 'post',
            cache : true,
            data : {
                eduSpec : education.eduSpec
            },
            success : function(resultObj) {
            	  console.log(resultObj);
              var j = 0;
              var file;
              var sa = $("#sa");
              for(var education of resultObj.educations) {
                file = resultObj.filesMap[j];
                j++;
                var fname = file[0].fileName;
                var url = fname.split('?')[1].split('=')[1];
                sa.append(
                      "<div role='button' style='margin-bottom:20px;' class='detailLnk' eduNo='" + education.eduNo + "'>"+
                      "<img class='detailLnk' width=270px; height=150px; eduNo='" + education.eduNo + "' src='//i.ytimg.com/vi/" + url + "/mqdefault.jpg' />"+
                      "<a class='detailLnk' style='margin-top:20px; text-decoration:none;' eduNo='" + education.eduNo + "' href='#'>" + education.eduTitle + "</a>"+
                      "</div>");
              }
              $("a.detailLnk").click(clickDetailLnk);
              $('div.detailLnk').click(clickDetailLnk);
            }
            
          });
        function clickDetailLnk(event) {
            event.preventDefault(); 
            location.href = "edu_form.html?eduNo=" + $(event.target).attr("eduNo");
        }
      }
    })
  </script>
  
  <script>
  $(document).ready(function() {
	  var no = $.session.get('mno');
	  var div = $('#user_info');
	  var btn = $('#scheduleAdd');
	  var ul = $('#menu-nav-ul');
	  var va = $('#ca');
	  if (no == undefined) {
	    div.append("<a href='../login.html' id='loginBtn'>로그인</a>");
	  } else if (no == 1) {
	    div.append(
	      "<a role='button' id='msgBtn' class='Msg' href='../messagebox.html'>" +
	        "<i class='fa fa-envelope-o'></i>" +
	        "<span class='badge' id='userBadge'>0</span>" +
	      "</a>" +
	      "<img src='../files/" + $.session.get('mimg') + "' id='userImg' />" +
	      "<a id='userName' href='#'>" + $.session.get('mname') + "</a>" +
	      "<a role='button' id='outBtn' class='logout'>" +
	        "<i class='fa fa-unlock fa-lg'></i>" +
	      "</a>")
	    
	    btn.append(
	      "<a class='btn btn-default' id='scheduleAdd' role='button'"
	      + "data-toggle='modal' data-target='#AddBoard'>New</a>")
	    
	    ul.append(
	      "<li><a href='../diary.html'><i class='lnr lnr-book'></i> 다이어리</a></li>")
	    $('#comimg').attr('src', '../files/' + $.session.get('mimg'));
	    
	    va.append(
	      "<a class='btn btn-default' id='deleteBtn' role='button'"
	      + ">삭제</a>"
	    )
	  } else {
	    div.append(
	      "<a role='button' id='msgBtn' class='Msg' href='../messagebox.html'>" +
	        "<i class='fa fa-envelope-o'></i>" +
	        "<span class='badge' id='userBadge'>0</span>" +
	      "</a>" +
	      "<img src='../files/" + $.session.get('mimg') + "' id='userImg' />" +
	      "<a id='userName' href='#'>" + $.session.get('mname') + "</a>" +
	      "<a role='button' id='outBtn' class='logout'>" +
	        "<i class='fa fa-unlock fa-lg'></i>" +
	      "</a>")
	    
	    ul.append(
	      "<li><a href='../diary.html'><i class='lnr lnr-book'></i> 다이어리</a></li>")
	    $('#comimg').attr('src', '../files/' + $.session.get('mimg'));
	  }

	  //    로그아웃
	  $(document).on("click", "#outBtn", function() {
	    $.session.clear();
	    location.href = "../login.html"
	  });
	  
	//삭제 버튼을 위한 이벤트 리스너 추가하기
	  $('#deleteBtn').click(function(event) {
	    $.getJSON('education/ajax/delete.do?eduNo=' + eduNo,
	      function(resultObj) {
	        var ajaxResult = resultObj.ajaxResult;
	        if (ajaxResult.status == "success") {
	        	  alert('게시물이 삭제 되었습니다.');
	          location.href = "education.html";
	        } else {
	            alert("게시물 삭제에 실패했습니다.");
	        }
	    });
	  });
	  
	  // 안읽은 받은쪽지 갯수 출력
	  var no = $.session.get('mno');
	  var form_data = new FormData();
	  form_data.append("recvMno", no)
	  $.ajax({
	    url: '../message/ajax/noReadMsg.do',
	    type: 'post',
	    dataType: 'json',
	    cache: false,
	    contentType: false,
	    processData: false,
	    data: form_data,
	    success: function(resultObj) {
	      var ajaxResult = resultObj.ajaxResult;
	      $('#userBadge').html(ajaxResult.data.noReadCount)
	    }
	  })
	});
  
  var i = 0;
  var form_data = new FormData();
  form_data.append("eduNo", eduNo)
  $.ajax({
    url: "../comment/ajax/educomlist.do",
    dataType: 'json',
    async: false,
    cache: false,
    contentType: false,
    processData: false,
    data: form_data,
    type: 'post',
    success: function(re) {
    	  $('#comComment').empty();
      var commen = re.comments;
      var comdiv = $('#comComment');
      var mem;
      var j = 0;
      for (var com of commen) {
        mem = re.memberMap[j];
        if($.session.get('mno') == mem.mno) {
          comdiv.append(
          "<div class='comment'>" +
            "<img class='commentimg' src='../files/" + mem.mImg + "'>" +
            "<div class='commentname'>" + mem.mName + "</div>" +
            "<a class='commentDel' id='" + com.comNo + "' onclick='del(this.id)'>" +
            "<i class='fa fa-close'></i></a>" +
            "<div class='commenttext'>" + com.comComment + "</div>" +
          "</div>")
        } else {
          comdiv.append(
          "<div class='comment'>" +
            "<img class='commentimg' src='../files/" + mem.mImg + "'>" +
            "<div class='commentname'>" + mem.mName + "</div>" +
            "<div class='commenttext'>" + com.comComment + "</div>" +
          "</div>")
        }
            j++;
      }
    },
    complete: function() {
    	  i++;
    }
  });
  
  $.getJSON('../comment/ajax/edupages.do?eduNo=' + eduNo, function(resultObj) {
      var ajaxResult = resultObj.ajaxResult
      console.log('resultObj : ' + resultObj)
      if (ajaxResult.data == 0) {
          $('#more').empty();
      }
  })
  
  $(document).on('click', '#comAddBtn', function() {
	    if ($('#comcontent').val() == "") {
	      alert("댓글을 입력해 주세요")
	    } else {
	        var form_data = new FormData();
	        form_data.append("eduNo", eduNo)
	        form_data.append("comComment", $('#comcontent').val())
	        form_data.append("mno", $.session.get('mno'))
	        $.ajax({
	            url: "../comment/ajax/educom.do",
	            dataType: 'json',
	            cache: false,
	            async: false,
	            contentType: false,
	            processData: false,
	            data: form_data,
	            type: 'post',
	            success: function(re) {
		            $('#comcontent').val('')
		            var form_data = new FormData();
		            form_data.append("eduNo", eduNo)
		            $.ajax({
		                url: "../comment/ajax/educomlist.do",
		                dataType: 'json',
		                cache: false,
		                contentType: false,
		                processData: false,
		                data: form_data,
		                type: 'post',
		                success: function(re) {
		                    $('#comComment').empty();
		                    var commen = re.comments;
		                    var comdiv = $('#comComment');
		                    var mem;
		                    var j = 0;
		                    for (var com of commen) {
		                        mem = re.memberMap[j];
		                        if($.session.get('mno') == mem.mno) {
		                            comdiv.append(
		                            "<div class='comment'>" +
		                            "<img class='commentimg' src='../files/" + mem.mImg + "'>" +
		                            "<div class='commentname'>" + mem.mName + "</div>" +
		                            "<a class='commentDel' id='" + com.comNo + "' onclick='del(this.id)'>" +
		                            "<i class='fa fa-close'></i></a>" +
		                            "<div class='commenttext'>" + com.comComment + "</div>" +
		                            "</div>")
		                        } else {
		                            comdiv.append(
		                            "<div class='comment'>" +
		                            "<img class='commentimg' src='../files/" + mem.mImg + "'>" +
		                            "<div class='commentname'>" + mem.mName + "</div>" +
		                            "<div class='commenttext'>" + com.comComment + "</div>" +
		                            "</div>")
		                        }
		                        j++;
		                    }
		                    $('#more').empty();
		                    $.getJSON('../comment/ajax/edupages.do?eduNo=' + eduNo, function(resultObj) {
		                        var ajaxResult = resultObj.ajaxResult
		                        console.log(resultObj)
		                        if (ajaxResult.data == 0 || ajaxResult.data == 1) {
		                            $('#more').empty();
		                        }
		                        else {
		                            $('#more').append(
		                                '<a role="button" class="moreBtn" id="m10" onclick="moree(this.id);">더보기</a>'
		                            );
		                        }
		                    })
		                    i=1;
		                }
            });
          }
        })
    }
});
	
	// 댓글 삭제 도우미
	function del(id) {
	    $('#comno').val(id)
	    $('#checkModal').modal('show')
	}

	// 댓글 삭제
	$(document).on("click", "#delCom", function() {
	    var form_data = new FormData();
	    console.log($('#comno').val())
	    form_data.append("comNo", $('#comno').val())
	    $.ajax({
	        url: "../comment/ajax/delete.do",
	        dataType: 'json',
	        cache: false,
	        contentType: false,
	        processData: false,
	        data: form_data,
	        type: 'post',
	        success: function(re) {
	            $('#checkModal').modal('hide')
	            var form_data = new FormData();
	            form_data.append("eduNo", eduNo)
	            $.ajax({
	                url: "../comment/ajax/educomlist.do",
	                dataType: 'json',
	                cache: false,
	                contentType: false,
	                processData: false,
	                data: form_data,
	                type: 'post',
	                success: function(re) {
	                    $('#comComment').empty();
	                    var commen = re.comments;
	                    var comdiv = $('#comComment');
	                    var mem;
	                    var j = 0;
	                    for (var com of commen) {
	                        mem = re.memberMap[j];
	                        comdiv.append(
	                        "<div class='comment'>" +
	                        "<img class='commentimg' src='../files/" + mem.mImg + "'>" +
	                        "<div class='commentname'>" + mem.mName + "</div>" +
	                        "<a class='commentDel' id='" + com.comNo + "' onclick='del(this.id)'>" +
	                        "<i class='fa fa-close'></i></a>" +
	                        "<div class='commenttext'>" + com.comComment + "</div>" +
	                        "</div>")
	                        j++;
	                    }
	                    $('#more').empty();
	                    $.getJSON('../comment/ajax/edupages.do?eduNo=' + eduNo, function(resultObj) {
	                        var ajaxResult = resultObj.ajaxResult
	                        console.log('resultObj : ' + resultObj)
	                        if (ajaxResult.data == 0 || ajaxResult.data == 1) {
	                            $('#more').empty();
	                        }
	                        else {
	                            $('#more').append(
	                                '<a role="button" class="moreBtn" id="m10" onclick="moree(this.id);">더보기</a>'
	                            );
	                        }
	                    })
	                    i=1;
	                }
	            })
	        }
	    })
	})

	// 더보기 부분
	function moree(id) {
	    i++;
	    console.log(id);
	    var page = id.substring(1);
	    console.log('page : ' + page);
	    var cpage = i;
	    console.log('cpage : ' + cpage);
	    var form_data = new FormData();
	    form_data.append("eduNo", eduNo)
	    form_data.append("pageNo", page)
	    $.ajax({
	        url: "../comment/ajax/educomlist.do",
	        dataType: 'json',
	        cache: false,
	        contentType: false,
	        processData: false,
	        data: form_data,
	        type: 'post',
	        success: function(re) {
	            var commen = re.comments;
	            var comdiv = $('#comComment');
	            var mem;
	            var j = 0;
	            for (var com of commen) {
	                mem = re.memberMap[j];
	                if($.session.get('mno') == mem.mno) {
	                    comdiv.append(
	                    "<div class='comment'>" +
	                    "<img class='commentimg' src='../files/" + mem.mImg + "'>" +
	                    "<div class='commentname'>" + mem.mName + "</div>" +
	                    "<a class='commentDel' id='" + com.comNo + "' onclick='del(this.id)'>" +
	                    "<i class='fa fa-close'></i></a>" +
	                    "<div class='commenttext'>" + com.comComment + "</div>" +
	                    "</div>")
	                } else {
	                    comdiv.append(
	                    "<div class='comment'>" +
	                    "<img class='commentimg' src='../files/" + mem.mImg + "'>" +
	                    "<div class='commentname'>" + mem.mName + "</div>" +
	                    "<div class='commenttext'>" + com.comComment + "</div>" +
	                    "</div>")
	                }
	                j++;
	            }

	            $.getJSON('../comment/ajax/edupages.do?eduNo=' + eduNo, function(resultObj) {
	                var ajaxResult = resultObj.ajaxResult;
	                console.log('cpage : ' + cpage);
	                console.log('ajaxResult.data : ' + ajaxResult.data);
	                if (ajaxResult.data == cpage) {
	                    console.log("더보기 끝")
	                    $('#more').empty();

	                } else {
	                    console.log("더보기 생성")
	                    var more = $('#more');
	                    $('#more').empty();
	                    var i = parseInt(page)+10;
	                    console.log(i);
	                    more.append(
	                          "<a role='button' class='moreBtn' id='m" + i + "' onclick='moree(this.id);'>더보기</a>")
	                }
	            })
	        }
	    })
	};
  </script>
</body>
</html>